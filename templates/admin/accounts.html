<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#00A650">
  <title>Accounts - DukaPOS Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#00A650',
            'primary-dark': '#059669',
            'primary-light': '#34D399',
            'primary-50': '#ECFDF5',
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .sidebar-link { @apply flex items-center gap-3 px-4 py-3 text-slate-300 hover:bg-white/10 hover:text-white rounded-xl transition-all; }
    .sidebar-link.active { @apply bg-primary text-white shadow-lg shadow-primary/25; }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-up { animation: fadeInUp 0.4s ease-out forwards; }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen">
  <!-- Header -->
  <header class="bg-white/10 backdrop-blur-xl border-b border-white/10 fixed top-0 left-0 right-0 z-50 h-16">
    <div class="max-w-full mx-auto px-4 h-full flex items-center justify-between">
      <div class="flex items-center gap-4">
        <a href="/admin/dashboard" class="flex items-center gap-2">
          <div class="w-9 h-9 bg-gradient-to-br from-primary to-primary-dark rounded-xl flex items-center justify-center shadow-lg shadow-primary/25">
            <i data-lucide="shield-check" class="text-white w-5 h-5"></i>
          </div>
          <span class="text-lg font-bold text-white">DukaPOS Admin</span>
        </a>
      </div>
      <div class="flex items-center gap-4">
        <a href="/admin/dashboard" class="text-slate-300 hover:text-white px-3 py-2 rounded-xl hover:bg-white/10 transition">Dashboard</a>
        <a href="/admin/accounts" class="text-primary font-medium px-3 py-2">Accounts</a>
        <a href="/admin/shops" class="text-slate-300 hover:text-white px-3 py-2 rounded-xl hover:bg-white/10 transition">Shops</a>
        <a href="/admin/settings" class="text-slate-300 hover:text-white px-3 py-2 rounded-xl hover:bg-white/10 transition">Settings</a>
        <span class="text-slate-600">|</span>
        <a href="/dashboard" class="text-primary font-medium hover:text-primary-light">View Site</a>
        <button onclick="logout()" class="text-red-400 hover:bg-red-500/20 px-3 py-2 rounded-xl transition">
          <i data-lucide="log-out" class="w-4 h-4"></i>
        </button>
      </div>
    </div>
  </header>

  <div class="flex pt-16">
    <!-- Sidebar -->
    <aside class="w-64 min-h-screen bg-white/5 border-r border-white/10 fixed left-0 top-16 bottom-0 p-4">
      <nav class="space-y-1">
        <a href="/admin/dashboard" class="sidebar-link">
          <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
          Dashboard
        </a>
        <a href="/admin/accounts" class="sidebar-link active">
          <i data-lucide="users" class="w-5 h-5"></i>
          Accounts
        </a>
        <a href="/admin/shops" class="sidebar-link">
          <i data-lucide="store" class="w-5 h-5"></i>
          Shops
        </a>
        <a href="/admin/subscriptions" class="sidebar-link">
          <i data-lucide="credit-card" class="w-5 h-5"></i>
          Subscriptions
        </a>
        <a href="/admin/settings" class="sidebar-link">
          <i data-lucide="settings" class="w-5 h-5"></i>
          Settings
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 ml-64 p-8">
      <div class="max-w-7xl mx-auto">
        <!-- Page Header -->
        <div class="flex items-center justify-between mb-8">
          <div>
            <h1 class="text-2xl font-bold text-white">Account Management</h1>
            <p class="text-slate-400 mt-1">Manage user accounts and subscriptions</p>
          </div>
          <div class="flex gap-3">
            <div class="relative">
              <input type="text" id="searchInput" placeholder="Search accounts..." 
                class="w-64 px-4 py-2.5 bg-white/10 border border-white/10 rounded-xl text-white placeholder-slate-500 focus:ring-2 focus:ring-primary/50 focus:border-primary">
              <i data-lucide="search" class="w-4 h-4 absolute right-3 top-3 text-slate-500"></i>
            </div>
          </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-4 gap-4 mb-8">
          <div class="bg-white/10 backdrop-blur-xl rounded-2xl p-5 border border-white/10">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-blue-500/20 rounded-xl flex items-center justify-center">
                <i data-lucide="users" class="w-5 h-5 text-blue-400"></i>
              </div>
              <div>
                <p class="text-slate-400 text-sm">Total</p>
                <p class="text-2xl font-bold text-white" id="totalCount">-</p>
              </div>
            </div>
          </div>
          <div class="bg-white/10 backdrop-blur-xl rounded-2xl p-5 border border-white/10">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-green-500/20 rounded-xl flex items-center justify-center">
                <i data-lucide="user-check" class="w-5 h-5 text-green-400"></i>
              </div>
              <div>
                <p class="text-slate-400 text-sm">Active</p>
                <p class="text-2xl font-bold text-white" id="activeCount">-</p>
              </div>
            </div>
          </div>
          <div class="bg-white/10 backdrop-blur-xl rounded-2xl p-5 border border-white/10">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-purple-500/20 rounded-xl flex items-center justify-center">
                <i data-lucide="zap" class="w-5 h-5 text-purple-400"></i>
              </div>
              <div>
                <p class="text-slate-400 text-sm">Pro</p>
                <p class="text-2xl font-bold text-white" id="proCount">-</p>
              </div>
            </div>
          </div>
          <div class="bg-white/10 backdrop-blur-xl rounded-2xl p-5 border border-white/10">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-amber-500/20 rounded-xl flex items-center justify-center">
                <i data-lucide="building" class="w-5 h-5 text-amber-400"></i>
              </div>
              <div>
                <p class="text-slate-400 text-sm">Business</p>
                <p class="text-2xl font-bold text-white" id="businessCount">-</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Accounts Table -->
        <div class="bg-white/10 backdrop-blur-xl rounded-2xl border border-white/10 overflow-hidden">
          <table class="w-full">
            <thead class="bg-white/5">
              <tr>
                <th class="px-6 py-4 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Account</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Phone</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Plan</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Status</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Joined</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-white/10" id="accountsTable">
              <tr>
                <td colspan="6" class="px-6 py-8 text-center text-slate-400">
                  <i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto mb-2"></i>
                  Loading accounts...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="flex items-center justify-between mt-6">
          <p class="text-slate-400 text-sm" id="paginationInfo">Showing 0 accounts</p>
          <div class="flex gap-2" id="paginationButtons"></div>
        </div>
      </div>
    </main>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center">
    <div class="bg-slate-800 rounded-2xl border border-white/10 w-full max-w-md p-6">
      <h3 class="text-xl font-bold text-white mb-4">Edit Account</h3>
      <form id="editForm">
        <input type="hidden" id="editAccountId">
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">Plan</label>
            <select id="editPlan" class="w-full px-4 py-3 bg-white/10 border border-white/10 rounded-xl text-white focus:ring-2 focus:ring-primary/50">
              <option value="free">Free</option>
              <option value="pro">Pro</option>
              <option value="business">Business</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">Status</label>
            <select id="editStatus" class="w-full px-4 py-3 bg-white/10 border border-white/10 rounded-xl text-white focus:ring-2 focus:ring-primary/50">
              <option value="true">Active</option>
              <option value="false">Inactive</option>
            </select>
          </div>
        </div>

        <div class="flex gap-3 mt-6">
          <button type="button" onclick="closeModal()" class="flex-1 py-3 px-4 bg-white/10 text-white rounded-xl hover:bg-white/20 transition">Cancel</button>
          <button type="submit" class="flex-1 py-3 px-4 bg-primary text-white rounded-xl hover:bg-primary-dark transition">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    lucide.createIcons();
    
    const token = localStorage.getItem('dukapos_token');
    if (!token) window.location.href = '/admin/login';

    let currentPage = 1;
    const limit = 20;

    async function loadAccounts() {
      try {
        const res = await fetch(`/api/v1/admin/accounts?page=${currentPage}&limit=${limit}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (res.status === 401 || res.status === 403) {
          logout();
          return;
        }
        
        const data = await res.json();
        
        // Update stats
        document.getElementById('totalCount').textContent = data.total || '0';
        document.getElementById('activeCount').textContent = data.active || '0';
        document.getElementById('proCount').textContent = data.pro || '0';
        document.getElementById('businessCount').textContent = data.business || '0';
        
        // Update table
        const tbody = document.getElementById('accountsTable');
        if (!data.accounts || data.accounts.length === 0) {
          tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-8 text-center text-slate-400">No accounts found</td></tr>`;
          return;
        }
        
        tbody.innerHTML = data.accounts.map(account => `
          <tr class="hover:bg-white/5 transition">
            <td class="px-6 py-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-primary/20 rounded-full flex items-center justify-center">
                  <span class="text-primary font-semibold">${account.name ? account.name.charAt(0).toUpperCase() : 'U'}</span>
                </div>
                <div>
                  <p class="text-white font-medium">${account.name || 'Unknown'}</p>
                  <p class="text-slate-400 text-sm">${account.email || 'No email'}</p>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 text-slate-300">${account.phone || '-'}</td>
            <td class="px-6 py-4">
              <span class="px-3 py-1 rounded-full text-xs font-medium ${
                account.plan === 'business' ? 'bg-amber-500/20 text-amber-400' :
                account.plan === 'pro' ? 'bg-purple-500/20 text-purple-400' :
                'bg-slate-500/20 text-slate-400'
              }">
                ${account.plan || 'free'}
              </span>
            </td>
            <td class="px-6 py-4">
              <span class="px-3 py-1 rounded-full text-xs font-medium ${
                account.is_active ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'
              }">
                ${account.is_active ? 'Active' : 'Inactive'}
              </span>
            </td>
            <td class="px-6 py-4 text-slate-400 text-sm">${new Date(account.created_at).toLocaleDateString()}</td>
            <td class="px-6 py-4">
              <button onclick="openEditModal(${account.id}, '${account.plan}', ${account.is_active})" 
                class="p-2 hover:bg-white/10 rounded-lg text-slate-400 hover:text-white transition">
                <i data-lucide="edit-2" class="w-4 h-4"></i>
              </button>
            </td>
          </tr>
        `).join('');
        
        lucide.createIcons();
        
        // Update pagination
        document.getElementById('paginationInfo').textContent = `Showing ${data.accounts.length} accounts`;
      } catch (err) {
        console.error('Failed to load accounts:', err);
      }
    }

    function openEditModal(id, plan, isActive) {
      document.getElementById('editAccountId').value = id;
      document.getElementById('editPlan').value = plan || 'free';
      document.getElementById('editStatus').value = isActive ? 'true' : 'false';
      document.getElementById('editModal').classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('editModal').classList.add('hidden');
    }

    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('editAccountId').value;
      const plan = document.getElementById('editPlan').value;
      const isActive = document.getElementById('editStatus').value === 'true';

      try {
        const res = await fetch(`/api/v1/admin/accounts/${id}/plan`, {
          method: 'PUT',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ plan })
        });

        if (res.ok) {
          await fetch(`/api/v1/admin/accounts/${id}/status`, {
            method: 'PUT',
            headers: { 
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ is_active: isActive })
          });
          
          showToast('Account updated successfully');
          closeModal();
          loadAccounts();
        } else {
          showToast('Failed to update account', 'error');
        }
      } catch (err) {
        showToast('Error updating account', 'error');
      }
    });

    function logout() {
      localStorage.removeItem('dukapos_token');
      localStorage.removeItem('dukapos_shop');
      localStorage.removeItem('dukapos_admin');
      window.location.href = '/admin/login';
    }

    function showToast(message, type = 'success') {
      const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
      const toast = document.createElement('div');
      toast.className = `fixed bottom-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-xl shadow-lg z-50`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    document.getElementById('searchInput').addEventListener('input', (e) => {
      // Implement search
    });

    loadAccounts();
  </script>
</body>
</html>
