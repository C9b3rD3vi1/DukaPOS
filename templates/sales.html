<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#00A650">
  <title>Sales - DukaPOS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#00A650',
            'primary-dark': '#059669',
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50">
  <!-- Header -->
  <header class="bg-white border-b border-gray-200 fixed top-0 left-0 right-0 z-50 h-16">
    <div class="max-w-full mx-auto px-4 h-full flex items-center justify-between">
      <div class="flex items-center">
        <button onclick="toggleSidebar()" class="md:hidden p-2 -ml-2 mr-2 text-gray-600">
          <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
        <a href="/" class="flex items-center gap-2">
          <div class="w-9 h-9 bg-primary rounded-xl flex items-center justify-center">
            <i data-lucide="shopping-bag" class="text-white w-5 h-5"></i>
          </div>
          <span class="text-lg font-bold text-gray-900">DukaPOS</span>
        </a>
      </div>
    </div>
  </header>

  <!-- Sidebar Overlay (mobile only) -->
  <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden" onclick="toggleSidebar()"></div>

  <!-- Sidebar -->
  <aside id="sidebar" class="fixed top-16 left-0 w-64 h-[calc(100vh-4rem)] bg-white border-r border-gray-200 z-40 transform -translate-x-full transition-transform duration-300 md:translate-x-0 overflow-y-auto">
    <nav class="p-4 space-y-1">
      <a href="/dashboard" class="flex items-center gap-3 px-3 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg transition">
        <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
        Dashboard
      </a>
      <a href="/products" class="flex items-center gap-3 px-3 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg transition">
        <i data-lucide="package" class="w-5 h-5"></i>
        Products
      </a>
      <a href="/sales" class="flex items-center gap-3 px-3 py-2.5 bg-primary/10 text-primary rounded-lg font-medium">
        <i data-lucide="receipt" class="w-5 h-5"></i>
        Sales
      </a>
      <div class="border-t border-gray-200 my-2"></div>
      <a href="/customers" class="flex items-center gap-3 px-3 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg transition">
        <i data-lucide="users" class="w-5 h-5"></i>
        Customers
      </a>
      <a href="/mpesa" class="flex items-center gap-3 px-3 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg transition">
        <i data-lucide="smartphone" class="w-5 h-5"></i>
        M-Pesa
      </a>
      <a href="/staff" class="flex items-center gap-3 px-3 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg transition">
        <i data-lucide="user-cog" class="w-5 h-5"></i>
        Staff
      </a>
      <a href="/settings" class="flex items-center gap-3 px-3 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg transition">
        <i data-lucide="settings" class="w-5 h-5"></i>
        Settings
      </a>
      <a href="/billing" class="flex items-center gap-3 px-3 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg transition">
        <i data-lucide="credit-card" class="w-5 h-5"></i>
        Billing
      </a>
      <a href="/sms" class="flex items-center gap-3 px-3 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg transition">
        <i data-lucide="message-square" class="w-5 h-5"></i>
        SMS
      </a>
      <a href="/email" class="flex items-center gap-3 px-3 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg transition">
        <i data-lucide="mail" class="w-5 h-5"></i>
        Email
      </a>
      <div class="border-t border-gray-200 my-2"></div>
      <a href="/logout" class="flex items-center gap-3 px-3 py-2.5 text-red-600 hover:bg-red-50 rounded-lg transition">
        <i data-lucide="log-out" class="w-5 h-5"></i>
        Logout
      </a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="pt-16 md:pl-64 min-h-screen">
    <div class="p-4 md:p-6 lg:p-8 max-w-7xl">
      <!-- Page Header -->
      <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900">Sales</h1>
        <p class="text-gray-500 mt-1">Your transactions</p>
      </div>

      <!-- Total Sales Card -->
      <div class="bg-white rounded-xl p-4 md:p-5 shadow-sm border border-gray-100 mb-6 flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Total Sales</p>
          <p class="text-2xl md:text-3xl font-bold text-gray-900" id="totalSales">KSh 0</p>
        </div>
        <div class="w-12 h-12 md:w-14 md:h-14 bg-green-100 rounded-xl flex items-center justify-center">
          <i data-lucide="trending-up" class="w-6 h-6 md:w-7 md:h-7 text-primary"></i>
        </div>
      </div>

      <!-- Sales List -->
      <div id="salesList">
        <div class="p-8 flex justify-center">
          <div class="w-8 h-8 border-4 border-gray-200 border-t-primary rounded-full animate-spin"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Sale Details Modal -->
  <div id="saleDetailsModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50" onclick="closeSaleDetails()"></div>
    <div class="absolute inset-x-4 top-[10%] md:inset-x-auto md:left-1/2 md:-translate-x-1/2 md:w-full md:max-w-lg bg-white rounded-2xl shadow-2xl max-h-[80vh] overflow-y-auto">
      <div class="p-6 border-b border-gray-200 flex items-center justify-between">
        <h3 class="text-lg font-bold text-gray-900">Sale Details</h3>
        <button onclick="closeSaleDetails()" class="p-2 hover:bg-gray-100 rounded-lg">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div id="saleDetailsContent" class="p-6">
        <div class="p-8 flex justify-center">
          <div class="w-8 h-8 border-4 border-gray-200 border-t-primary rounded-full animate-spin"></div>
        </div>
      </div>
      <div class="p-6 border-t border-gray-200 bg-gray-50 rounded-b-2xl">
        <button onclick="closeSaleDetails()" class="w-full py-2.5 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition">Close</button>
      </div>
    </div>
  </div>

  <!-- Edit Sale Modal -->
  <div id="editSaleModal" class="fixed inset-0 bg-black/50 z-50 hidden items-end sm:items-center justify-center p-0 sm:p-4">
    <div class="bg-white w-full sm:w-96 sm:rounded-2xl rounded-t-2xl p-6 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-lg font-semibold text-gray-900">Edit Sale</h3>
        <button onclick="closeModal('editSaleModal')" class="p-2 text-gray-400 hover:text-gray-600">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <form id="editSaleForm" class="space-y-4">
        <input type="hidden" id="editSaleId">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
          <input type="text" id="editSaleProduct" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary bg-gray-50" readonly>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
            <input type="number" id="editSaleQuantity" min="1" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Unit Price</label>
            <input type="number" id="editSaleUnitPrice" min="0" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" required>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Payment Method</label>
          <select id="editSalePaymentMethod" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
            <option value="cash">Cash</option>
            <option value="mpesa">M-Pesa</option>
            <option value="card">Card</option>
          </select>
        </div>
        <div class="bg-gray-50 rounded-lg p-4 text-center">
          <p class="text-sm text-gray-500">Total Amount</p>
          <p class="text-2xl font-bold text-gray-900" id="editSaleTotal">KSh 0</p>
        </div>
        <button type="submit" class="w-full py-3 bg-primary text-white rounded-lg font-medium hover:bg-primary-dark transition">Save Changes</button>
      </form>
    </div>
  </div>

  <!-- Mobile Bottom Navigation -->
  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-50 md:hidden pb-safe">
    <div class="flex justify-around items-center h-16">
      <a href="/dashboard" class="flex flex-col items-center justify-center w-full h-full text-gray-500 hover:text-gray-900">
        <i data-lucide="home" class="w-5 h-5"></i>
        <span class="text-xs mt-1">Home</span>
      </a>
      <a href="/products" class="flex flex-col items-center justify-center w-full h-full text-gray-500 hover:text-gray-900">
        <i data-lucide="package" class="w-5 h-5"></i>
        <span class="text-xs mt-1">Products</span>
      </a>
      <a href="/dashboard" class="flex flex-col items-center justify-center w-full h-full text-gray-500 hover:text-gray-900">
        <div class="w-12 h-12 bg-primary rounded-full flex items-center justify-center -mt-4 shadow-lg">
          <i data-lucide="plus" class="w-6 h-6 text-white"></i>
        </div>
        <span class="text-xs mt-1">Sell</span>
      </a>
      <a href="/sales" class="flex flex-col items-center justify-center w-full h-full text-primary">
        <i data-lucide="receipt" class="w-5 h-5"></i>
        <span class="text-xs mt-1">Sales</span>
      </a>
      <button onclick="toggleSidebar()" class="flex flex-col items-center justify-center w-full h-full text-gray-500 hover:text-gray-900">
        <i data-lucide="menu" class="w-5 h-5"></i>
        <span class="text-xs mt-1">Menu</span>
      </button>
    </div>
  </nav>

  <script>
    console.log('Sales page loading...');
    try {
    lucide.createIcons();
    
    const token = localStorage.getItem('dukapos_token');
    console.log('Token:', token ? 'present' : 'missing');
    if (!token) {
      console.log('Redirecting to login...');
      window.location.href = '/login';
      return;
    }
    
    const shop = JSON.parse(localStorage.getItem('dukapos_shop') || '{}');
    const shopId = shop.id || 1;
    console.log('Shop ID:', shopId);
    
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.toggle('-translate-x-full');
      overlay.classList.toggle('hidden');
    }
    
    function formatNumber(num) {
      return new Intl.NumberFormat('en-KE').format(Math.round(num || 0));
    }
    
    async function loadSales() {
      try {
        const res = await fetch('/api/v1/sales', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        const sales = data.data || data || [];
        
        let total = 0;
        const container = document.getElementById('salesList');
        
        if (!sales || sales.length === 0) {
          container.innerHTML = `
            <div class="text-center py-12">
              <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="receipt" class="w-8 h-8 text-gray-400"></i>
              </div>
              <p class="text-gray-500 mb-2">No sales recorded yet</p>
              <p class="text-sm text-gray-400 mb-4">Record your first sale from the dashboard</p>
              <a href="/dashboard" class="px-4 py-2 bg-primary text-white rounded-lg">Go to Dashboard</a>
            </div>`;
          lucide.createIcons();
          return;
        }
        
        container.innerHTML = sales.map(s => {
          total += s.total_amount || 0;
          const productName = s.product?.name || 'Product';
          const methodColors = { 
            mpesa: 'bg-yellow-100 text-yellow-800', 
            cash: 'bg-green-100 text-green-800', 
            card: 'bg-blue-100 text-blue-800' 
          };
          
          return `
            <div class="bg-white rounded-xl p-4 mb-3 shadow-sm border border-gray-100 flex items-center justify-between cursor-pointer hover:shadow-md transition" onclick="viewSaleDetails(${s.id})">
              <div>
                <p class="font-semibold text-gray-900">${productName}</p>
                <p class="text-sm text-gray-500">${new Date(s.created_at).toLocaleDateString()}</p>
              </div>
              <div class="text-right">
                <p class="font-semibold text-gray-900">KSh ${formatNumber(s.total_amount)}</p>
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${methodColors[s.payment_method] || 'bg-green-100 text-green-800'}">${s.payment_method || 'cash'}</span>
                <button onclick="event.stopPropagation(); printReceipt(${s.id})" class="ml-2 p-1.5 text-gray-400 hover:text-primary hover:bg-primary/10 rounded-lg transition" title="Print Receipt">
                  <i data-lucide="printer" class="w-4 h-4"></i>
                </button>
              </div>
            </div>`;
        }).join('');
        
        document.getElementById('totalSales').textContent = `KSh ${formatNumber(total)}`;
        lucide.createIcons();
      } catch (err) {
        console.error(err);
      }
    }
    
    async function viewSaleDetails(saleId) {
      const modal = document.getElementById('saleDetailsModal');
      const content = document.getElementById('saleDetailsContent');
      modal.classList.remove('hidden');
      lucide.createIcons();
      
      try {
        const res = await fetch(`/api/v1/sales/${saleId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!res.ok) throw new Error('Failed to load sale details');
        
        const sale = await res.json();
        
        const methodColors = { 
          mpesa: 'bg-yellow-100 text-yellow-800', 
          cash: 'bg-green-100 text-green-800', 
          card: 'bg-blue-100 text-blue-800' 
        };
        
        content.innerHTML = `
          <div class="space-y-4">
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
              <div>
                <p class="text-sm text-gray-500">Total Amount</p>
                <p class="text-2xl font-bold text-gray-900">KSh ${formatNumber(sale.total_amount)}</p>
              </div>
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${methodColors[sale.payment_method] || 'bg-green-100 text-green-800'}">
                ${sale.payment_method || 'cash'}
              </span>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
              <div class="p-4 bg-gray-50 rounded-xl">
                <p class="text-sm text-gray-500">Product</p>
                <p class="font-semibold text-gray-900">${sale.product?.name || 'N/A'}</p>
              </div>
              <div class="p-4 bg-gray-50 rounded-xl">
                <p class="text-sm text-gray-500">Quantity</p>
                <p class="font-semibold text-gray-900">${sale.quantity || 1}</p>
              </div>
            </div>
            
            <div class="p-4 bg-gray-50 rounded-xl">
              <p class="text-sm text-gray-500">Date & Time</p>
              <p class="font-semibold text-gray-900">${new Date(sale.created_at).toLocaleString()}</p>
            </div>
            
             ${sale.mpesa_transaction_id ? `
            <div class="p-4 bg-yellow-50 rounded-xl border border-yellow-200">
              <p class="text-sm text-yellow-700">M-Pesa Transaction ID</p>
              <p class="font-mono font-semibold text-yellow-800">${sale.mpesa_transaction_id}</p>
            </div>
            ` : ''}
            
            <div class="pt-4 border-t border-gray-200 grid grid-cols-2 gap-3">
              <button onclick="editSale(${sale.id})" class="py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition flex items-center justify-center gap-2">
                <i data-lucide="edit-2" class="w-5 h-5"></i>
                Edit Sale
              </button>
              <button onclick="deleteSale(${sale.id})" class="py-3 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition flex items-center justify-center gap-2">
                <i data-lucide="trash-2" class="w-5 h-5"></i>
                Delete
              </button>
            </div>
          </div>
        `;
        lucide.createIcons();
      } catch (err) {
        console.error(err);
        content.innerHTML = `
          <div class="text-center py-8">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <i data-lucide="alert-circle" class="w-8 h-8 text-red-600"></i>
            </div>
            <p class="text-red-600 font-medium">Failed to load sale details</p>
            <p class="text-sm text-gray-500 mt-1">Please try again</p>
          </div>
        `;
        lucide.createIcons();
      }
    }
    
    function closeSaleDetails() {
      document.getElementById('saleDetailsModal').classList.add('hidden');
    }
    
    let currentSale = null;
    
    async function editSale(saleId) {
      try {
        const res = await fetch(`/api/v1/sales/${saleId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!res.ok) throw new Error('Failed to load sale');
        
        currentSale = await res.json();
        
        document.getElementById('editSaleId').value = currentSale.id;
        document.getElementById('editSaleProduct').value = currentSale.product?.name || 'N/A';
        document.getElementById('editSaleQuantity').value = currentSale.quantity || 1;
        document.getElementById('editSaleUnitPrice').value = currentSale.unit_price || (currentSale.total_amount / (currentSale.quantity || 1));
        document.getElementById('editSalePaymentMethod').value = currentSale.payment_method || 'cash';
        
        updateEditSaleTotal();
        
        closeSaleDetails();
        document.getElementById('editSaleModal').classList.remove('hidden');
        document.getElementById('editSaleModal').classList.add('flex');
        lucide.createIcons();
      } catch (err) {
        console.error(err);
        showToast('Failed to load sale for editing', 'error');
      }
    }
    
    function updateEditSaleTotal() {
      const qty = parseInt(document.getElementById('editSaleQuantity').value) || 1;
      const price = parseFloat(document.getElementById('editSaleUnitPrice').value) || 0;
      document.getElementById('editSaleTotal').textContent = `KSh ${formatNumber(qty * price)}`;
    }
    
    document.getElementById('editSaleQuantity')?.addEventListener('input', updateEditSaleTotal);
    document.getElementById('editSaleUnitPrice')?.addEventListener('input', updateEditSaleTotal);
    
    document.getElementById('editSaleForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const saleId = document.getElementById('editSaleId').value;
      const data = {
        quantity: parseInt(document.getElementById('editSaleQuantity').value),
        unit_price: parseFloat(document.getElementById('editSaleUnitPrice').value),
        payment_method: document.getElementById('editSalePaymentMethod').value,
        total_amount: parseInt(document.getElementById('editSaleQuantity').value) * parseFloat(document.getElementById('editSaleUnitPrice').value)
      };
      
      try {
        const res = await fetch(`/api/v1/sales/${saleId}`, {
          method: 'PUT',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(data)
        });
        
        if (res.ok) {
          showToast('Sale updated successfully!', 'success');
          closeModal('editSaleModal');
          loadSales();
        } else {
          const error = await res.json();
          showToast(error.error || 'Failed to update sale', 'error');
        }
      } catch (err) {
        showToast('Error updating sale', 'error');
      }
    });
    
    async function deleteSale(saleId) {
      if (!confirm('Are you sure you want to delete this sale? This action cannot be undone.')) return;
      
      try {
        const res = await fetch(`/api/v1/sales/${saleId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (res.ok) {
          showToast('Sale deleted successfully', 'success');
          closeSaleDetails();
          loadSales();
        } else {
          showToast('Failed to delete sale', 'error');
        }
      } catch (err) {
        showToast('Error deleting sale', 'error');
      }
    }
    
    async function printReceipt(saleId) {
      try {
        const res = await fetch(`/api/v1/sales/${saleId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!res.ok) throw new Error('Failed to load sale details');
        
        const sale = await res.json();
        
        const productName = sale.product?.name || 'Unknown Product';
        const quantity = sale.quantity || 1;
        const unitPrice = sale.unit_price || sale.total_amount / quantity;
        
        // Try backend receipt printing first
        try {
          const printRes = await fetch('/api/v1/print/receipt', {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              sale_id: sale.id,
              items: [{
                name: productName,
                quantity: quantity,
                unit_price: unitPrice,
                total: sale.total_amount
              }],
              total: sale.total_amount,
              payment_method: sale.payment_method || 'cash',
              created_at: sale.created_at
            })
          });
          
          if (printRes.ok) {
            showToast('Receipt sent to printer via backend', 'success');
            return;
          }
        } catch (backendErr) {
          console.log('Backend printing failed, falling back to browser print');
        }
        
        // Fallback to browser print
        const receiptHTML = `
          <div id="printable-receipt" style="font-family: monospace; width: 300px; padding: 20px; background: white;">
            <div style="text-align: center; margin-bottom: 20px;">
              <h2 style="margin: 0; font-size: 18px;">${shop.name || 'DukaPOS'}</h2>
              <p style="margin: 5px 0; font-size: 12px;">Receipt #${sale.id}</p>
              <p style="margin: 5px 0; font-size: 12px;">${new Date(sale.created_at).toLocaleString()}</p>
            </div>
            
            <div style="border-top: 1px dashed #000; border-bottom: 1px dashed #000; padding: 10px 0; margin: 10px 0;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>${productName}</span>
                <span>x${quantity}</span>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                <span>Unit Price: KSh ${formatNumber(unitPrice)}</span>
              </div>
            </div>
            
            <div style="margin-top: 15px;">
              <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 16px;">
                <span>TOTAL:</span>
                <span>KSh ${formatNumber(sale.total_amount)}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 12px;">
                <span>Payment Method:</span>
                <span>${sale.payment_method || 'cash'}</span>
              </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px; font-size: 11px; color: #666;">
              <p>Thank you for your business!</p>
              <p>Powered by DukaPOS</p>
            </div>
          </div>
        `;
        
        // Open print window
        const printWindow = window.open('', '_blank', 'width=400,height=600');
        printWindow.document.write(`
          <html>
            <head>
              <title>Receipt #${sale.id}</title>
              <style>
                @media print {
                  body { margin: 0; }
                  #printable-receipt { width: 100%; }
                }
              </style>
            </head>
            <body>
              ${receiptHTML}
              <script>
                window.onload = function() {
                  window.print();
                  window.onafterprint = function() {
                    window.close();
                  };
                };
              </script>
            </body>
          </html>
        `);
        printWindow.document.close();
        
        showToast('Receipt sent to printer', 'success');
      } catch (err) {
        console.error(err);
        showToast('Failed to print receipt', 'error');
      }
    }
    
    loadSales();
    } catch (err) {
      console.error('Sales page error:', err);
    }
  </script>
</body>
</html>
